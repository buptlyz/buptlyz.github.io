<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Personal tech blog.">
<meta name="keywords" content="Github Page Hexo">
<meta property="og:type" content="website">
<meta property="og:title" content="沙雕爹爹">
<meta property="og:url" content="https://buptlyz.github.io/page/5/index.html">
<meta property="og:site_name" content="沙雕爹爹">
<meta property="og:description" content="Personal tech blog.">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="沙雕爹爹">
<meta name="twitter:description" content="Personal tech blog.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://buptlyz.github.io/page/5/">





  <title>沙雕爹爹</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">沙雕爹爹</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay foolish, stay humble.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/22/lodash源码之debounce-throttle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/22/lodash源码之debounce-throttle/" itemprop="url">lodash源码之debounce/throttle</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-22T23:07:04+08:00">
                2019-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/lodash/lodash/blob/master/debounce.js" target="_blank" rel="noopener">debounce源码</a><br><a href="https://github.com/lodash/lodash/blob/master/throttle.js" target="_blank" rel="noopener">throttle源码</a></p>
<h2 id="debounce"><a href="#debounce" class="headerlink" title="debounce"></a>debounce</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> isObject <span class="keyword">from</span> <span class="string">'./isObject.js'</span></span><br><span class="line"><span class="keyword">import</span> root <span class="keyword">from</span> <span class="string">'./.internal/root.js'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个函数，延迟执行`func`，直到上次`func`执行之后`wait`毫秒，或者下一次浏览器绘制帧。</span></span><br><span class="line"><span class="comment"> * 函数返回一个`cancel`函数来取消延迟的`func`的执行，和一个`flush`方法来立即执行。</span></span><br><span class="line"><span class="comment"> * 接收一个options对象，用来指定`func`是在`wait`时间间隔的头/尾执行。</span></span><br><span class="line"><span class="comment"> * `func`使用最新的传参执行。一组调用只返回最新那次函数调用的计算结果。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * **Note:** 如果`leading`和`trailing`选项都是`true`，只有当`func`在`wait`时间段内执行超过一次，才会在时间段的尾边界执行。</span></span><br><span class="line"><span class="comment"> * 如果`wait`是`0`，并且`leading`是`false`，`func`延迟到下一次tick，类似setTimeout 0。</span></span><br><span class="line"><span class="comment"> * 如果`wait`被忽略，并且环境中有`requestAnimationFrame`方法，`func`将延迟到下一次帧绘制时执行(特指16ms)。</span></span><br><span class="line"><span class="comment"> * 查看[David Corbacho的文章](https://css-tricks.com/debouncing-throttling-explained-examples/)了解debounce和throttle的不同之处。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @since 0.1.0</span></span><br><span class="line"><span class="comment"> * @category Function</span></span><br><span class="line"><span class="comment"> * @param &#123;Function&#125; func The function to debounce.</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; [wait=0]</span></span><br><span class="line"><span class="comment"> *  The number of milliseconds to delay; if omitted, `requestAnimationFrame` is</span></span><br><span class="line"><span class="comment"> *  used (if available).</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; [options=&#123;&#125;] The options object.</span></span><br><span class="line"><span class="comment"> * @param &#123;boolean&#125; [options.leading=false]</span></span><br><span class="line"><span class="comment"> *  Specify invoking on the leading edge of the timeout.</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; [options.maxWait]</span></span><br><span class="line"><span class="comment"> *  The maximum time `func` is allowed to be delayed before it's invoked.</span></span><br><span class="line"><span class="comment"> * @param &#123;boolean&#125; [options.trailing=true]</span></span><br><span class="line"><span class="comment"> *  Specify invoking on the trailing edge of the timeout.</span></span><br><span class="line"><span class="comment"> * @returns &#123;Function&#125; Returns the new debounced function.</span></span><br><span class="line"><span class="comment"> * @example</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Avoid costly calculations while the window size is in flux.</span></span><br><span class="line"><span class="comment"> * jQuery(window).on('resize', debounce(calculateLayout, 150))</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Invoke `sendMail` when clicked, debouncing subsequent calls.</span></span><br><span class="line"><span class="comment"> * jQuery(element).on('click', debounce(sendMail, 300, &#123;</span></span><br><span class="line"><span class="comment"> *   'leading': true,</span></span><br><span class="line"><span class="comment"> *   'trailing': false</span></span><br><span class="line"><span class="comment"> * &#125;))</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Ensure `batchLog` is invoked once after 1 second of debounced calls.</span></span><br><span class="line"><span class="comment"> * const debounced = debounce(batchLog, 250, &#123; 'maxWait': 1000 &#125;)</span></span><br><span class="line"><span class="comment"> * const source = new EventSource('/stream')</span></span><br><span class="line"><span class="comment"> * jQuery(source).on('message', debounced)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Cancel the trailing debounced invocation.</span></span><br><span class="line"><span class="comment"> * jQuery(window).on('popstate', debounced.cancel)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Check for pending invocations.</span></span><br><span class="line"><span class="comment"> * const status = debounced.pending() ? "Pending..." : "Ready"</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">func, wait, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> lastArgs,</span><br><span class="line">    lastThis,</span><br><span class="line">    maxWait,</span><br><span class="line">    result,</span><br><span class="line">    timerId,</span><br><span class="line">    lastCallTime</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lastInvokeTime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> leading = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> maxing = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> trailing = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bypass `requestAnimationFrame` by explicitly setting `wait=0`.</span></span><br><span class="line">  <span class="keyword">const</span> useRAF = (!wait &amp;&amp; wait !== <span class="number">0</span> &amp;&amp; <span class="keyword">typeof</span> root.requestAnimationFrame === <span class="string">'function'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> func !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Expected a function'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  wait = +wait || <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (isObject(options)) &#123;</span><br><span class="line">    leading = !!options.leading</span><br><span class="line">    maxing = <span class="string">'maxWait'</span> <span class="keyword">in</span> options</span><br><span class="line">    maxWait = maxing ? <span class="built_in">Math</span>.max(+options.maxWait || <span class="number">0</span>, wait) : maxWait</span><br><span class="line">    trailing = <span class="string">'trailing'</span> <span class="keyword">in</span> options ? !!options.trailing : trailing</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">invokeFunc</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> args = lastArgs</span><br><span class="line">    <span class="keyword">const</span> thisArg = lastThis</span><br><span class="line"></span><br><span class="line">    lastArgs = lastThis = <span class="literal">undefined</span></span><br><span class="line">    lastInvokeTime = time</span><br><span class="line">    result = func.apply(thisArg, args)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">startTimer</span>(<span class="params">pendingFunc, wait</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (useRAF) &#123;</span><br><span class="line">      root.cancelAnimationFrame(timerId);</span><br><span class="line">      <span class="keyword">return</span> root.requestAnimationFrame(pendingFunc)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setTimeout(pendingFunc, wait)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">cancelTimer</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (useRAF) &#123;</span><br><span class="line">      <span class="keyword">return</span> root.cancelAnimationFrame(id)</span><br><span class="line">    &#125;</span><br><span class="line">    clearTimeout(id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">leadingEdge</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Reset any `maxWait` timer.</span></span><br><span class="line">    lastInvokeTime = time</span><br><span class="line">    <span class="comment">// Start the timer for the trailing edge.</span></span><br><span class="line">    timerId = startTimer(timerExpired, wait)</span><br><span class="line">    <span class="comment">// Invoke the leading edge.</span></span><br><span class="line">    <span class="keyword">return</span> leading ? invokeFunc(time) : result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">remainingWait</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastCall = time - lastCallTime</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastInvoke = time - lastInvokeTime</span><br><span class="line">    <span class="keyword">const</span> timeWaiting = wait - timeSinceLastCall</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> maxing</span><br><span class="line">      ? <span class="built_in">Math</span>.min(timeWaiting, maxWait - timeSinceLastInvoke)</span><br><span class="line">      : timeWaiting</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shouldInvoke</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastCall = time - lastCallTime</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastInvoke = time - lastInvokeTime</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Either this is the first call, activity has stopped and we're at the</span></span><br><span class="line">    <span class="comment">// trailing edge, the system time has gone backwards and we're treating</span></span><br><span class="line">    <span class="comment">// it as the trailing edge, or we've hit the `maxWait` limit.</span></span><br><span class="line">    <span class="keyword">return</span> (lastCallTime === <span class="literal">undefined</span> || (timeSinceLastCall &gt;= wait) ||</span><br><span class="line">      (timeSinceLastCall &lt; <span class="number">0</span>) || (maxing &amp;&amp; timeSinceLastInvoke &gt;= maxWait))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">timerExpired</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> time = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">if</span> (shouldInvoke(time)) &#123;</span><br><span class="line">      <span class="keyword">return</span> trailingEdge(time)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Restart the timer.</span></span><br><span class="line">    timerId = startTimer(timerExpired, remainingWait(time))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">trailingEdge</span>(<span class="params">time</span>) </span>&#123;</span><br><span class="line">    timerId = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only invoke if we have `lastArgs` which means `func` has been</span></span><br><span class="line">    <span class="comment">// debounced at least once.</span></span><br><span class="line">    <span class="keyword">if</span> (trailing &amp;&amp; lastArgs) &#123;</span><br><span class="line">      <span class="keyword">return</span> invokeFunc(time)</span><br><span class="line">    &#125;</span><br><span class="line">    lastArgs = lastThis = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">cancel</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timerId !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      cancelTimer(timerId)</span><br><span class="line">    &#125;</span><br><span class="line">    lastInvokeTime = <span class="number">0</span></span><br><span class="line">    lastArgs = lastCallTime = lastThis = timerId = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flush</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> timerId === <span class="literal">undefined</span> ? result : trailingEdge(<span class="built_in">Date</span>.now())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pending</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> timerId !== <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">debounced</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> time = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">const</span> isInvoking = shouldInvoke(time)</span><br><span class="line"></span><br><span class="line">    lastArgs = args</span><br><span class="line">    lastThis = <span class="keyword">this</span></span><br><span class="line">    lastCallTime = time</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isInvoking) &#123;</span><br><span class="line">      <span class="keyword">if</span> (timerId === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> leadingEdge(lastCallTime)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (maxing) &#123;</span><br><span class="line">        <span class="comment">// Handle invocations in a tight loop.</span></span><br><span class="line">        timerId = startTimer(timerExpired, wait)</span><br><span class="line">        <span class="keyword">return</span> invokeFunc(lastCallTime)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timerId === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      timerId = startTimer(timerExpired, wait)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">  debounced.cancel = cancel</span><br><span class="line">  debounced.flush = flush</span><br><span class="line">  debounced.pending = pending</span><br><span class="line">  <span class="keyword">return</span> debounced</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> debounce</span><br></pre></td></tr></table></figure>
<h2 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> debounce <span class="keyword">from</span> <span class="string">'./debounce.js'</span></span><br><span class="line"><span class="keyword">import</span> isObject <span class="keyword">from</span> <span class="string">'./isObject.js'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a throttled function that only invokes `func` at most once per</span></span><br><span class="line"><span class="comment"> * every `wait` milliseconds (or once per browser frame). The throttled function</span></span><br><span class="line"><span class="comment"> * comes with a `cancel` method to cancel delayed `func` invocations and a</span></span><br><span class="line"><span class="comment"> * `flush` method to immediately invoke them. Provide `options` to indicate</span></span><br><span class="line"><span class="comment"> * whether `func` should be invoked on the leading and/or trailing edge of the</span></span><br><span class="line"><span class="comment"> * `wait` timeout. The `func` is invoked with the last arguments provided to the</span></span><br><span class="line"><span class="comment"> * throttled function. Subsequent calls to the throttled function return the</span></span><br><span class="line"><span class="comment"> * result of the last `func` invocation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * **Note:** If `leading` and `trailing` options are `true`, `func` is</span></span><br><span class="line"><span class="comment"> * invoked on the trailing edge of the timeout only if the throttled function</span></span><br><span class="line"><span class="comment"> * is invoked more than once during the `wait` timeout.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `wait` is `0` and `leading` is `false`, `func` invocation is deferred</span></span><br><span class="line"><span class="comment"> * until the next tick, similar to `setTimeout` with a timeout of `0`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If `wait` is omitted in an environment with `requestAnimationFrame`, `func`</span></span><br><span class="line"><span class="comment"> * invocation will be deferred until the next frame is drawn (typically about</span></span><br><span class="line"><span class="comment"> * 16ms).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See [David Corbacho's article](https://css-tricks.com/debouncing-throttling-explained-examples/)</span></span><br><span class="line"><span class="comment"> * for details over the differences between `throttle` and `debounce`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @since 0.1.0</span></span><br><span class="line"><span class="comment"> * @category Function</span></span><br><span class="line"><span class="comment"> * @param &#123;Function&#125; func The function to throttle.</span></span><br><span class="line"><span class="comment"> * @param &#123;number&#125; [wait=0]</span></span><br><span class="line"><span class="comment"> *  The number of milliseconds to throttle invocations to; if omitted,</span></span><br><span class="line"><span class="comment"> *  `requestAnimationFrame` is used (if available).</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; [options=&#123;&#125;] The options object.</span></span><br><span class="line"><span class="comment"> * @param &#123;boolean&#125; [options.leading=true]</span></span><br><span class="line"><span class="comment"> *  Specify invoking on the leading edge of the timeout.</span></span><br><span class="line"><span class="comment"> * @param &#123;boolean&#125; [options.trailing=true]</span></span><br><span class="line"><span class="comment"> *  Specify invoking on the trailing edge of the timeout.</span></span><br><span class="line"><span class="comment"> * @returns &#123;Function&#125; Returns the new throttled function.</span></span><br><span class="line"><span class="comment"> * @example</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Avoid excessively updating the position while scrolling.</span></span><br><span class="line"><span class="comment"> * jQuery(window).on('scroll', throttle(updatePosition, 100))</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Invoke `renewToken` when the click event is fired, but not more than once every 5 minutes.</span></span><br><span class="line"><span class="comment"> * const throttled = throttle(renewToken, 300000, &#123; 'trailing': false &#125;)</span></span><br><span class="line"><span class="comment"> * jQuery(element).on('click', throttled)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // Cancel the trailing throttled invocation.</span></span><br><span class="line"><span class="comment"> * jQuery(window).on('popstate', throttled.cancel)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">func, wait, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> leading = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> trailing = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> func !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Expected a function'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isObject(options)) &#123;</span><br><span class="line">    leading = <span class="string">'leading'</span> <span class="keyword">in</span> options ? !!options.leading : leading</span><br><span class="line">    trailing = <span class="string">'trailing'</span> <span class="keyword">in</span> options ? !!options.trailing : trailing</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> debounce(func, wait, &#123;</span><br><span class="line">    leading,</span><br><span class="line">    trailing,</span><br><span class="line">    <span class="string">'maxWait'</span>: wait,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> throttle</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/22/rc-notification源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/22/rc-notification源码解析/" itemprop="url">rc-notification源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-22T22:57:22+08:00">
                2019-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/react-component/notification" target="_blank" rel="noopener">github地址</a><br><a href="http://react-component.github.io/notification/examples/simple.html" target="_blank" rel="noopener">示例地址</a></p>
<h2 id="Notification"><a href="#Notification" class="headerlink" title="Notification"></a><a href="https://github.com/react-component/notification/blob/master/src/Notification.jsx" target="_blank" rel="noopener">Notification</a></h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> Animate <span class="keyword">from</span> <span class="string">'rc-animate'</span>;</span><br><span class="line"><span class="keyword">import</span> createChainedFunction <span class="keyword">from</span> <span class="string">'rc-util/lib/createChainedFunction'</span>;</span><br><span class="line"><span class="keyword">import</span> classnames <span class="keyword">from</span> <span class="string">'classnames'</span>;</span><br><span class="line"><span class="keyword">import</span> Notice <span class="keyword">from</span> <span class="string">'./Notice'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用来生成唯一标识符uuid</span></span><br><span class="line"><span class="keyword">let</span> seed = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUuid</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`rcNotification_<span class="subst">$&#123;now&#125;</span>_<span class="subst">$&#123;seed++&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notification -&gt; Animate -&gt; Notices</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notification</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">    prefixCls: PropTypes.string,</span><br><span class="line">    transitionName: PropTypes.string,</span><br><span class="line">    animation: PropTypes.oneOfType([PropTypes.string, PropTypes.object]),</span><br><span class="line">    style: PropTypes.object,</span><br><span class="line">    maxCount: PropTypes.number,</span><br><span class="line">    closeIcon: PropTypes.node,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">    prefixCls: <span class="string">'rc-notification'</span>,</span><br><span class="line">    animation: <span class="string">'fade'</span>,</span><br><span class="line">    style: &#123;</span><br><span class="line">      top: <span class="number">65</span>,</span><br><span class="line">      left: <span class="string">'50%'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    notices: [],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// transitionName</span></span><br><span class="line">  getTransitionName() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">let</span> transitionName = props.transitionName;</span><br><span class="line">    <span class="keyword">if</span> (!transitionName &amp;&amp; props.animation) &#123;</span><br><span class="line">      transitionName = <span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-<span class="subst">$&#123;props.animation&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transitionName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加notice</span></span><br><span class="line">  add = <span class="function">(<span class="params">notice</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = notice.key = notice.key || getUuid();</span><br><span class="line">    <span class="keyword">const</span> &#123; maxCount &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function"><span class="params">previousState</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> notices = previousState.notices;</span><br><span class="line">      <span class="keyword">const</span> noticeIndex = notices.map(<span class="function"><span class="params">v</span> =&gt;</span> v.key).indexOf(key);</span><br><span class="line">      <span class="keyword">const</span> updatedNotices = notices.concat();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 已存在key值相同的notice，则用新的替换旧的</span></span><br><span class="line">      <span class="keyword">if</span> (noticeIndex !== <span class="number">-1</span>) &#123;</span><br><span class="line">        updatedNotices.splice(noticeIndex, <span class="number">1</span>, notice);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 超出notice的maxCount，则先删除第一个，再添加到队列末尾</span></span><br><span class="line">        <span class="comment">// 没有超出则直接添加到队列末尾</span></span><br><span class="line">        <span class="keyword">if</span> (maxCount &amp;&amp; notices.length &gt;= maxCount) &#123;</span><br><span class="line">          <span class="comment">// 使用第一项的key来更新新添加的项（让react移除现有的，而不是先删除再挂载）。</span></span><br><span class="line">          <span class="comment">// 复用旧的key值是为了：a) 外部人工控制；b)内部react的key属性不是很好用。</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// XXX, use key of first item to update new added (let React to move exsiting</span></span><br><span class="line">          <span class="comment">// instead of remove and mount). Same key was used before for both a) external</span></span><br><span class="line">          <span class="comment">// manual control and b) internal react 'key' prop , which is not that good.</span></span><br><span class="line">          notice.updateKey = updatedNotices[<span class="number">0</span>].updateKey || updatedNotices[<span class="number">0</span>].key;</span><br><span class="line">          updatedNotices.shift();</span><br><span class="line">        &#125;</span><br><span class="line">        updatedNotices.push(notice);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        notices: updatedNotices,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除特定key的notice</span></span><br><span class="line">  remove = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function"><span class="params">previousState</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        notices: previousState.notices.filter(<span class="function"><span class="params">notice</span> =&gt;</span> notice.key !== key),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; notices &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// notice节点，每个notice对应一个Notice组件实例</span></span><br><span class="line">    <span class="keyword">const</span> noticeNodes = notices.map(<span class="function">(<span class="params">notice, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> update = <span class="built_in">Boolean</span>(index === notices.length - <span class="number">1</span> &amp;&amp; notice.updateKey);</span><br><span class="line">      <span class="keyword">const</span> key = notice.updateKey ? notice.updateKey : notice.key;</span><br><span class="line">      <span class="keyword">const</span> onClose = createChainedFunction(<span class="keyword">this</span>.remove.bind(<span class="keyword">this</span>, notice.key), notice.onClose);</span><br><span class="line">      <span class="keyword">return</span> (&lt;Notice</span><br><span class="line">        prefixCls=&#123;props.prefixCls&#125;</span><br><span class="line">        &#123;...notice&#125;</span><br><span class="line">        key=&#123;key&#125;</span><br><span class="line">        update=&#123;update&#125;</span><br><span class="line">        onClose=&#123;onClose&#125;</span><br><span class="line">        onClick=&#123;notice.onClick&#125;</span><br><span class="line">        closeIcon=&#123;props.closeIcon&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;notice.content&#125;</span><br><span class="line">      &lt;/Notice&gt;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> className = &#123;</span><br><span class="line">      [props.prefixCls]: <span class="number">1</span>,</span><br><span class="line">      [props.className]: !!props.className,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div className=&#123;classnames(className)&#125; style=&#123;props.style&#125;&gt;</span><br><span class="line">        &lt;Animate transitionName=&#123;<span class="keyword">this</span>.getTransitionName()&#125;&gt;&#123;noticeNodes&#125;&lt;<span class="regexp">/Animate&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态方法，创建Notification实例</span></span><br><span class="line">Notification.newInstance = <span class="function"><span class="keyword">function</span> <span class="title">newNotificationInstance</span>(<span class="params">properties, callback</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getContainer是Notification instance的容器，最终append到body里</span></span><br><span class="line">  <span class="keyword">const</span> &#123; getContainer, ...props &#125; = properties || &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">  <span class="keyword">if</span> (getContainer) &#123;</span><br><span class="line">    <span class="keyword">const</span> root = getContainer();</span><br><span class="line">    root.appendChild(div);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(div);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> called = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拿到notification的ref</span></span><br><span class="line">  <span class="comment">// 包装成&#123;notice, removeNotice, destroy, component&#125;，并传给callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ref</span>(<span class="params">notification</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (called) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    called = <span class="literal">true</span>;</span><br><span class="line">    callback(&#123;</span><br><span class="line">      notice(noticeProps) &#123;</span><br><span class="line">        notification.add(noticeProps);</span><br><span class="line">      &#125;,</span><br><span class="line">      removeNotice(key) &#123;</span><br><span class="line">        notification.remove(key);</span><br><span class="line">      &#125;,</span><br><span class="line">      component: notification,</span><br><span class="line">      destroy() &#123;</span><br><span class="line">        ReactDOM.unmountComponentAtNode(div);</span><br><span class="line">        div.parentNode.removeChild(div);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  ReactDOM.render(&lt;Notification &#123;...props&#125; ref=&#123;ref&#125; /&gt;, div);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export default Notification;</span><br></pre></td></tr></table></figure>
<h2 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a><a href="https://github.com/react-component/notification/blob/master/src/Notice.jsx" target="_blank" rel="noopener">Notice</a></h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> classNames <span class="keyword">from</span> <span class="string">'classnames'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* 1. 展示notice内容，关闭icon</span></span><br><span class="line"><span class="comment">* 2. 点击事件、关闭事件</span></span><br><span class="line"><span class="comment">* 3. 持续时间后调用`props.onClose()`</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Notice</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">    duration: PropTypes.number,</span><br><span class="line">    onClose: PropTypes.func,</span><br><span class="line">    children: PropTypes.any,</span><br><span class="line">    update: PropTypes.bool,</span><br><span class="line">    closeIcon: PropTypes.node,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">    onEnd() &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    onClose() &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    duration: <span class="number">1.5</span>,</span><br><span class="line">    style: &#123;</span><br><span class="line">      right: <span class="string">'50%'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.startCloseTimer();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.duration !== prevProps.duration</span><br><span class="line">      || <span class="keyword">this</span>.props.update) &#123;</span><br><span class="line">      <span class="keyword">this</span>.restartCloseTimer();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.clearCloseTimer();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e) &#123;</span><br><span class="line">      e.stopPropagation();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.clearCloseTimer();</span><br><span class="line">    <span class="keyword">this</span>.props.onClose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  startCloseTimer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.duration) &#123;</span><br><span class="line">      <span class="keyword">this</span>.closeTimer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.close();</span><br><span class="line">      &#125;, <span class="keyword">this</span>.props.duration * <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  clearCloseTimer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.closeTimer) &#123;</span><br><span class="line">      clearTimeout(<span class="keyword">this</span>.closeTimer);</span><br><span class="line">      <span class="keyword">this</span>.closeTimer = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  restartCloseTimer() &#123;</span><br><span class="line">    <span class="keyword">this</span>.clearCloseTimer();</span><br><span class="line">    <span class="keyword">this</span>.startCloseTimer();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> componentClass = <span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-notice`</span>;</span><br><span class="line">    <span class="keyword">const</span> className = &#123;</span><br><span class="line">      [<span class="string">`<span class="subst">$&#123;componentClass&#125;</span>`</span>]: <span class="number">1</span>,</span><br><span class="line">      [<span class="string">`<span class="subst">$&#123;componentClass&#125;</span>-closable`</span>]: props.closable,</span><br><span class="line">      [props.className]: !!props.className,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div</span><br><span class="line">        className=&#123;classNames(className)&#125;</span><br><span class="line">        style=&#123;props.style&#125;</span><br><span class="line">        onMouseEnter=&#123;<span class="keyword">this</span>.clearCloseTimer&#125;</span><br><span class="line">        onMouseLeave=&#123;<span class="keyword">this</span>.startCloseTimer&#125;</span><br><span class="line">        onClick=&#123;props.onClick&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;div className=&#123;<span class="string">`<span class="subst">$&#123;componentClass&#125;</span>-content`</span>&#125;&gt;&#123;props.children&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &#123;props.closable ?</span></span><br><span class="line"><span class="regexp">            &lt;a tabIndex="0" onClick=&#123;this.close&#125; className=&#123;`$&#123;componentClass&#125;-close`&#125;&gt;</span></span><br><span class="line"><span class="regexp">              &#123;props.closeIcon || &lt;span className=&#123;`$&#123;componentClass&#125;-close-x`&#125;/</span>&gt;&#125;</span><br><span class="line">            &lt;<span class="regexp">/a&gt; : null</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable no-console */</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'rc-notification/assets/index.css'</span>;</span><br><span class="line"><span class="keyword">import</span> Notification <span class="keyword">from</span> <span class="string">'rc-notification'</span>;</span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">let</span> notification = <span class="literal">null</span>;</span><br><span class="line">Notification.newInstance(&#123;&#125;, (n) =&gt; notification = n);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">simpleFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  notification.notice(&#123;</span><br><span class="line">    content: &lt;span&gt;simple show&lt;/span&gt;,</span><br><span class="line">    onClose() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'simple close'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">durationFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  notification.notice(&#123;</span><br><span class="line">    content: &lt;span&gt;can not close...&lt;/span&gt;,</span><br><span class="line">    duration: <span class="literal">null</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">closableFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  notification.notice(&#123;</span><br><span class="line">    content: &lt;span&gt;closable&lt;/span&gt;,</span><br><span class="line">    duration: <span class="literal">null</span>,</span><br><span class="line">    onClose() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'closable close'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    closable: <span class="literal">true</span>,</span><br><span class="line">    onClick() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'clicked!!!'</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  notification.removeNotice(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">manualClose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="built_in">Date</span>.now();</span><br><span class="line">  notification.notice(&#123;</span><br><span class="line">    content: &lt;div&gt;</span><br><span class="line">      &lt;p&gt;click below button to close&lt;/p&gt;</span><br><span class="line">      &lt;button onClick=&#123;close.bind(null, key)&#125;&gt;close&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;,</span><br><span class="line">    key,</span><br><span class="line">    duration: <span class="literal">null</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> intervalKey;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updatableFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (counter !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">'updatable-notification'</span>;</span><br><span class="line">  <span class="keyword">const</span> initialProps = &#123;</span><br><span class="line">    content: <span class="string">`Timer: <span class="subst">$&#123;counter&#125;</span>s`</span>,</span><br><span class="line">    key,</span><br><span class="line">    duration: <span class="literal">null</span>,</span><br><span class="line">    closable: <span class="literal">true</span>,</span><br><span class="line">    onClose() &#123;</span><br><span class="line">      clearInterval(intervalKey);</span><br><span class="line">      counter = <span class="number">0</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  notification.notice(initialProps);</span><br><span class="line">  intervalKey = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    notification.notice(&#123; ...initialProps, <span class="attr">content</span>: <span class="string">`Timer: <span class="subst">$&#123;++counter&#125;</span>s`</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> notification2 = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> clearPath = <span class="string">'M793 242H366v-74c0-6.7-7.7-10.4-12.9'</span> +</span><br><span class="line">  <span class="string">'-6.3l-142 112c-4.1 3.2-4.1 9.4 0 12.6l142 112c'</span> +</span><br><span class="line">  <span class="string">'5.2 4.1 12.9 0.4 12.9-6.3v-74h415v470H175c-4.4'</span> +</span><br><span class="line">  <span class="string">' 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h618c35.3 0 64-'</span> +</span><br><span class="line">  <span class="string">'28.7 64-64V306c0-35.3-28.7-64-64-64z'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getSvg = <span class="function">(<span class="params">path, props = &#123;&#125;, align = <span class="literal">false</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;i &#123;...props&#125;&gt;</span><br><span class="line">      &lt;svg</span><br><span class="line">        viewBox=<span class="string">"0 0 1024 1024"</span></span><br><span class="line">        width=<span class="string">"1em"</span></span><br><span class="line">        height=<span class="string">"1em"</span></span><br><span class="line">        fill=<span class="string">"currentColor"</span></span><br><span class="line">        style=&#123;align ? &#123; <span class="attr">verticalAlign</span>: <span class="string">'-.125em '</span> &#125; : &#123;&#125;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;path d=&#123;path&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/svg&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/i</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line">Notification.newInstance(&#123;</span><br><span class="line">  closeIcon: getSvg(clearPath, &#123;&#125;, <span class="literal">true</span>),</span><br><span class="line">&#125;, (n) =&gt; &#123;</span><br><span class="line">  notification2 = n;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">customCloseIconFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  notification2.notice(&#123;</span><br><span class="line">    content: <span class="string">'It is using custom close icon...'</span>,</span><br><span class="line">    closable: <span class="literal">true</span>,</span><br><span class="line">    duration: <span class="number">0</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;div&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;button onClick=&#123;simpleFn&#125;&gt;simple show&lt;/button&gt;</span><br><span class="line">    &lt;button onClick=&#123;durationFn&#125;&gt;duration=0&lt;/button&gt;</span><br><span class="line">    &lt;button onClick=&#123;closableFn&#125;&gt;closable&lt;/button&gt;</span><br><span class="line">    &lt;button onClick=&#123;manualClose&#125;&gt;controlled close&lt;/button&gt;</span><br><span class="line">    &lt;button onClick=&#123;updatableFn&#125;&gt;updatable&lt;/button&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;button onClick=&#123;customCloseIconFn&#125;&gt;custom close icon&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;, <span class="built_in">document</span>.getElementById(<span class="string">'__react-content'</span>));</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/22/antd-message源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/22/antd-message源码分析/" itemprop="url">antd message源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-22T22:20:57+08:00">
                2019-04-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/ant-design/ant-design/blob/master/components/message/index.tsx" target="_blank" rel="noopener">github地址</a>。<br>调用了 <a href="https://github.com/react-component/notification" target="_blank" rel="noopener"><code>rc-notification</code></a> 模块。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* global Promise */</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> Notification <span class="keyword">from</span> <span class="string">'rc-notification'</span>;</span><br><span class="line"><span class="keyword">import</span> Icon <span class="keyword">from</span> <span class="string">'../icon'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> defaultDuration = <span class="number">3</span>;            <span class="comment">// 持续时间 s</span></span><br><span class="line"><span class="keyword">let</span> defaultTop: <span class="built_in">number</span>;             <span class="comment">// css top值</span></span><br><span class="line"><span class="keyword">let</span> messageInstance: <span class="built_in">any</span>;           <span class="comment">// message实例</span></span><br><span class="line"><span class="keyword">let</span> key = <span class="number">1</span>;                        <span class="comment">// 自增key</span></span><br><span class="line"><span class="keyword">let</span> prefixCls = <span class="string">'ant-message'</span>;      <span class="comment">// prefix cls</span></span><br><span class="line"><span class="keyword">let</span> transitionName = <span class="string">'move-up'</span>;     <span class="comment">// transition</span></span><br><span class="line"><span class="keyword">let</span> getContainer: <span class="function"><span class="params">()</span> =&gt;</span> HTMLElement;<span class="comment">// container</span></span><br><span class="line"><span class="keyword">let</span> maxCount: <span class="built_in">number</span>;               <span class="comment">// message个数阈值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* 如果有 messageInstance 则 callback(messageInstance)</span></span><br><span class="line"><span class="comment">* 否则创建一个 messageInstance 再 callback(messageInstance)</span></span><br><span class="line"><span class="comment">* @param &#123;any&#125; callback</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMessageInstance</span>(<span class="params">callback: (i: <span class="built_in">any</span>) =&gt; <span class="built_in">void</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (messageInstance) &#123;</span><br><span class="line">    callback(messageInstance);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Notification.newInstance(&#123;</span><br><span class="line">    prefixCls,</span><br><span class="line">    transitionName,</span><br><span class="line">    style: &#123; top: defaultTop &#125;, <span class="comment">// 覆盖原来的样式</span></span><br><span class="line">    getContainer,</span><br><span class="line">    maxCount,</span><br><span class="line">  &#125;, <span class="function">(<span class="params">instance: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (messageInstance) &#123;</span><br><span class="line">      callback(messageInstance);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    messageInstance = instance;</span><br><span class="line">    callback(instance);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NoticeType = <span class="string">'info'</span> | <span class="string">'success'</span> | <span class="string">'error'</span> | <span class="string">'warning'</span> | <span class="string">'loading'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ThenableArgument &#123;</span><br><span class="line">  (_: <span class="built_in">any</span>): <span class="built_in">any</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> MessageType &#123;</span><br><span class="line">  (): <span class="built_in">void</span>;</span><br><span class="line">  then: <span class="function">(<span class="params">fill: ThenableArgument, reject: ThenableArgument</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  promise: <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @param &#123;React.ReactNode&#125; content message组件的content</span></span><br><span class="line"><span class="comment">* @param &#123;func | number&#125; duration 持续时间</span></span><br><span class="line"><span class="comment">* @param &#123;NoticeType&#125; type 类型</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notice</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  content: React.ReactNode,</span></span></span><br><span class="line"><span class="function"><span class="params">  duration: (() =&gt; <span class="built_in">void</span>) | <span class="built_in">number</span> = defaultDuration,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: NoticeType,</span></span></span><br><span class="line"><span class="function"><span class="params">  onClose?: () =&gt; <span class="built_in">void</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">MessageType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> iconType = (&#123;</span><br><span class="line">    info: <span class="string">'info-circle'</span>,</span><br><span class="line">    success: <span class="string">'check-circle'</span>,</span><br><span class="line">    error: <span class="string">'cross-circle'</span>,</span><br><span class="line">    warning: <span class="string">'exclamation-circle'</span>,</span><br><span class="line">    loading: <span class="string">'loading'</span>,</span><br><span class="line">  &#125;)[<span class="keyword">type</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> duration === <span class="string">'function'</span>) &#123;</span><br><span class="line">    onClose = duration;</span><br><span class="line">    duration = defaultDuration;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> target = key++;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 messageInstance，并将 onClose 作为 callback 传进去</span></span><br><span class="line">  <span class="keyword">const</span> closePromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> callback =  <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> onClose === <span class="string">'function'</span>) &#123;</span><br><span class="line">        onClose();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> resolve(<span class="literal">true</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    getMessageInstance(<span class="function">(<span class="params">instance</span>) =&gt;</span> &#123;</span><br><span class="line">      instance.notice(&#123;</span><br><span class="line">        key: target,</span><br><span class="line">        duration,</span><br><span class="line">        style: &#123;&#125;,</span><br><span class="line">        content: (</span><br><span class="line">          &lt;div className=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-custom-content <span class="subst">$&#123;prefixCls&#125;</span>-<span class="subst">$&#123;type&#125;</span>`</span>&#125;&gt;</span><br><span class="line">            &lt;Icon <span class="keyword">type</span>=&#123;iconType&#125; /&gt;</span><br><span class="line">            &lt;span&gt;&#123;content&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">        ),</span><br><span class="line">        onClose: callback,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> result: <span class="built_in">any</span> = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (messageInstance) &#123;</span><br><span class="line">      messageInstance.removeNotice(target);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  result.then = <span class="function">(<span class="params">filled: ThenableArgument, rejected: ThenableArgument</span>) =&gt;</span> closePromise.then(filled, rejected);</span><br><span class="line">  result.promise = closePromise;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回remove notice的函数</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ConfigContent = React.ReactNode | <span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">type</span> ConfigDuration = <span class="built_in">number</span> | <span class="function">(<span class="params">(<span class="params"></span>) =&gt; <span class="built_in">void</span></span>);</span></span><br><span class="line"><span class="function"><span class="params">export</span> <span class="params">type</span> <span class="params">ConfigOnClose</span> = <span class="params">()</span> =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> ConfigOptions &#123;</span><br><span class="line">  top?: <span class="built_in">number</span>;</span><br><span class="line">  duration?: <span class="built_in">number</span>;</span><br><span class="line">  prefixCls?: <span class="built_in">string</span>;</span><br><span class="line">  getContainer?: <span class="function"><span class="params">()</span> =&gt;</span> HTMLElement;</span><br><span class="line">  transitionName?: <span class="built_in">string</span>;</span><br><span class="line">  maxCount?: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  info(content: ConfigContent, duration?: ConfigDuration, onClose?: ConfigOnClose) &#123;</span><br><span class="line">    <span class="keyword">return</span> notice(content, duration, <span class="string">'info'</span>, onClose);</span><br><span class="line">  &#125;,</span><br><span class="line">  success(content: ConfigContent, duration?: ConfigDuration, onClose?: ConfigOnClose) &#123;</span><br><span class="line">    <span class="keyword">return</span> notice(content, duration, <span class="string">'success'</span>, onClose);</span><br><span class="line">  &#125;,</span><br><span class="line">  error(content: ConfigContent, duration?: ConfigDuration, onClose?: ConfigOnClose) &#123;</span><br><span class="line">    <span class="keyword">return</span> notice(content, duration, <span class="string">'error'</span>, onClose);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Departed usage, please use warning()</span></span><br><span class="line">  warn(content: ConfigContent, duration?: ConfigDuration, onClose?: ConfigOnClose) &#123;</span><br><span class="line">    <span class="keyword">return</span> notice(content, duration, <span class="string">'warning'</span>, onClose);</span><br><span class="line">  &#125;,</span><br><span class="line">  warning(content: ConfigContent, duration?: ConfigDuration, onClose?: ConfigOnClose) &#123;</span><br><span class="line">    <span class="keyword">return</span> notice(content, duration, <span class="string">'warning'</span>, onClose);</span><br><span class="line">  &#125;,</span><br><span class="line">  loading(content: ConfigContent, duration?: ConfigDuration, onClose?: ConfigOnClose) &#123;</span><br><span class="line">    <span class="keyword">return</span> notice(content, duration, <span class="string">'loading'</span>, onClose);</span><br><span class="line">  &#125;,</span><br><span class="line">  config(options: ConfigOptions) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.top !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      defaultTop = options.top;</span><br><span class="line">      messageInstance = <span class="literal">null</span>; <span class="comment">// delete messageInstance for new defaultTop</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.duration !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      defaultDuration = options.duration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.prefixCls !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      prefixCls = options.prefixCls;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.getContainer !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      getContainer = options.getContainer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.transitionName !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      transitionName = options.transitionName;</span><br><span class="line">      messageInstance = <span class="literal">null</span>; <span class="comment">// delete messageInstance for new transitionName</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.maxCount !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      maxCount = options.maxCount;</span><br><span class="line">      messageInstance = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  destroy() &#123;</span><br><span class="line">    <span class="keyword">if</span> (messageInstance) &#123;</span><br><span class="line">      messageInstance.destroy();</span><br><span class="line">      messageInstance = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/21/Node-js事件循环，定时器和process-nextTick/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/Node-js事件循环，定时器和process-nextTick/" itemprop="url">Node.js事件循环，定时器和process.nextTick(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-21T21:46:01+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener">原文链接</a><br><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/" target="_blank" rel="noopener">英文链接</a></p>
<h2 id="什么是事件轮询"><a href="#什么是事件轮询" class="headerlink" title="什么是事件轮询"></a>什么是事件轮询</h2><p>事件循环是Node.js处理非阻塞I/O操作的机制——尽管Javascript是单线程处理的——当有可能的时候，它们会把操作转移到系统内核中区。</p>
<p>既然目前大多数内核都是多线程的，它们可在后台处理多种操作。当其中的一个操作完成的时候，内核通知Node.js将适合的回调函数添加到<em>轮询</em>队列中等待时机执行。我们在本文后面会进行详细介绍。</p>
<h2 id="事件轮询机制解析"><a href="#事件轮询机制解析" class="headerlink" title="事件轮询机制解析"></a>事件轮询机制解析</h2><p>当Node.js启动后，它会初始化事件轮询；处理已提供的输入脚本（或丢入<a href="https://nodejs.org/api/repl.html#repl_repl" target="_blank" rel="noopener"><code>REPL</code></a>，本文不涉及到），它可能会调用一些异步的API函数调用，安排任务处理事件，或者调用<code>process.nextTick()</code>，然后开始处理事件循环。</p>
<p>下面的图表显示了事件循环的概述以及操作顺序。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   ┌───────────────────────────┐</span><br><span class="line">┌─&gt;│           timers          │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │     pending callbacks     │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │       idle, prepare       │</span><br><span class="line">│  └─────────────┬─────────────┘      ┌───────────────┐</span><br><span class="line">│  ┌─────────────┴─────────────┐      │   incoming:   │</span><br><span class="line">│  │           poll            │<span class="xml"><span class="tag">&lt;<span class="name">─────┤</span>  <span class="attr">connections</span>, │</span></span></span><br><span class="line"><span class="xml">│  └─────────────┬─────────────┘      │   data, etc.  │</span></span><br><span class="line"><span class="xml">│  ┌─────────────┴─────────────┐      └───────────────┘</span></span><br><span class="line"><span class="xml">│  │           check           │</span></span><br><span class="line"><span class="xml">│  └─────────────┬─────────────┘</span></span><br><span class="line"><span class="xml">│  ┌─────────────┴─────────────┐</span></span><br><span class="line"><span class="xml">└──┤      close callbacks      │</span></span><br><span class="line"><span class="xml">   └───────────────────────────┘</span></span><br></pre></td></tr></table></figure>
<p><em>注意：每个框框里每一步都是事件循环机制的一个阶段</em></p>
<p>每个阶段都有一个FIFO队列来执行回调。虽然每个阶段都是特殊的，但通常情况下，当事件循环进入给定的阶段时，它将执行特定于该阶段的任何操作，然后在该阶段的队列中执行回调，直到队列用尽或最大回调数已执行。当该队列已用尽或达到回调限制，事件循环将移动到下一阶段，等等。</p>
<p>由于这些操作中的任何一个都可能计划<em>更多</em>的操作，并且在<strong>轮询</strong>阶段处理的新事件由内核排队，因此在处理轮询事件时，轮询事件可以排队。因此，长时间运行回调可以允许轮询阶段运行大量长于计时器的阈值。有关详细信息，请参阅<a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#timers" target="_blank" rel="noopener">计时器</a>和<a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#poll" target="_blank" rel="noopener">轮询</a>部分。</p>
<p><strong>注意</strong> <em>：在Windows和Unix/Linux实现之间存在细微的差异，但这对演示来说并不重要。最重要的部分在这里。实际上由七或八个步骤，但我们关心但是Node.js实际上使用以上的某些步骤。</em></p>
<h2 id="阶段概述"><a href="#阶段概述" class="headerlink" title="阶段概述"></a>阶段概述</h2><ul>
<li><strong>定时器</strong>：本阶段执行已经安排的<code>setTimeout()</code>和<code>setInterval()</code>的回调函数</li>
<li><strong>待定回调</strong>：执行延迟到下一个循环迭代的I/O回调。</li>
<li><strong>idle，prepare</strong>：仅系统内部使用。</li>
<li><strong>轮询</strong>：检索新的I/O事件；执行于I/O相关的回调（几乎所有情况下，除了关闭的回调函数，它们由计时器和<code>setImmediate()</code>排定的之外），其余情况node将在此处阻塞。</li>
<li><strong>检测</strong>：<code>setImmediate()</code>回调函数在这里执行。</li>
<li><strong>关闭的回调函数</strong>：一些准备关闭的回调函数，如：<code>socket.on(&#39;close&#39;, ...)</code>。</li>
</ul>
<p>在每次运行的事件循环之间，Node.js检查它是否在等待任何异步I/O或计时器，如果没有的话，则关闭干净。</p>
<h2 id="阶段的详细概述"><a href="#阶段的详细概述" class="headerlink" title="阶段的详细概述"></a>阶段的详细概述</h2><h3 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h3><p>定时器指定<em>可执行所提供回调</em>的<strong>阈值</strong>，而不是用户希望其执行的确切时间。计时器回调将尽可能早地运行，因为它们可以在指定的时间间隔后进行调度。但是操作系统调度或其它调度的运行可能会延迟它们。</p>
<p><strong>注意：</strong> <em><a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#poll" target="_blank" rel="noopener">轮询阶段</a>控制何时定时器执行。</em></p>
<p>例如，假设计划在100毫秒后执行超时阈值，然后脚本开始异步读取文件，这需要95毫秒：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">someAsyncOperation</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Assume this takes 95ms to complete</span></span><br><span class="line">  fs.readFile(<span class="string">'/path/to/file'</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeoutScheduled = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> delay = <span class="built_in">Date</span>.now() - timeoutScheduled;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;delay&#125;</span>ms have passed since I was scheduled`</span>);</span><br><span class="line">&#125;, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// do someAsyncOperation which takes 95 ms to complete</span></span><br><span class="line">someAsyncOperation(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> startCallback = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// do something that will take 10ms...</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">Date</span>.now() - startCallback &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="comment">// do nothing</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当事件循环进入<strong>轮询</strong>阶段时，它有一个空队列（此时<code>fs.readFile()</code>尚未完成），因此它将等待毫秒数，直到达到最快的计时器阈值为止。当它等待95毫秒通过时，<code>fs.readFile()</code>完成读取文件，它需要10毫秒完成的回调将添加到<strong>轮询</strong>队列中并执行。当回调完成时，队列中不再有回调，因此事件循环将看到已达到最快计时器的阈值，然后将回滚到<strong>计时器</strong>阶段，以执行定时器的回调。在本实例中，将看到计划中的定时器和执行的回调之间的总延迟将为105毫秒。</p>
<p><strong>注意：</strong> <em>为了防止</em> <strong>轮询</strong> <em>阶段饿死事件循环，<a href="http://libuv.org/" target="_blank" rel="noopener">libuv</a>（实现Node.js事件循环和平台的所有异步行为的C函数库），在停止轮询以获得更多事件之前，还有一个最大的（系统依赖）。</em></p>
<h3 id="挂起的回调函数"><a href="#挂起的回调函数" class="headerlink" title="挂起的回调函数"></a>挂起的回调函数</h3><h3 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h3><p><strong>轮询</strong>阶段有两个重要的功能：</p>
<ol>
<li>计算应该阻塞和轮询I/O的时间。</li>
<li>然后，处理<strong>轮询</strong>队列里的事件。</li>
</ol>
<p>当事件循环进入<strong>轮询</strong>阶段且<em>没有计划计时器时</em>，将发生以下两种情况之一：</p>
<ul>
<li><em>如果<strong>轮询</strong>队列<strong>不是空的</strong></em>，事件循环将循环访问其回调队列并同步执行它们，直到队列已用尽，或者达到里与系统相关的硬限制。</li>
<li><em>如果<strong>轮询</strong>队列<strong>是空的</strong></em>，还有两件事发生：<ul>
<li>如果脚本已按<code>setImmediate()</code>排定，则事件循环将结束<strong>轮询</strong>阶段，并继续<strong>检查</strong>阶段以执行这些计划脚本。</li>
<li>如果脚本<strong>尚未</strong>按<code>setImmediate()</code>排定，则事件循环将等待回调添加到队列中，然后立即执行。</li>
</ul>
</li>
</ul>
<p>一旦<strong>轮询</strong>队列唯恐，事件循环将检查<em>已达到时间阈值的计时器</em>。如果一个或多个计时器已准备就绪，则事件循环将绕回计时器阶段以执行这些计时器的回调。</p>
<h3 id="检查阶段"><a href="#检查阶段" class="headerlink" title="检查阶段"></a>检查阶段</h3><p>此阶段允许人员在轮询阶段完成后立即执行回调。如果轮询阶段变为空闲状态，并且脚本已排队使用<code>setImmediate()</code>，则事件循环可以继续到<strong>检查</strong>阶段而不是等待。</p>
<p><code>setImmediate()</code>实际上是一个在事件循环的单独阶段运行的特殊计时器。它使用一个libuv API来安排回调在<strong>轮询</strong>阶段完成后执行。</p>
<p>通常，在执行代码时，事件循环最终会命中轮询阶段，等待传入连接、请求等。但是，如果回调已计划为<code>setImmediate()</code>，并且轮询阶段变为空闲状态，则它将结束并继续到检查阶段而不是等待轮询事件。</p>
<h3 id="关闭的回调函数"><a href="#关闭的回调函数" class="headerlink" title="关闭的回调函数"></a>关闭的回调函数</h3><p>如果套接字或处理函数突然关闭（例如<code>socket.destroy()）</code>，则<code>&#39;close&#39;</code>事件将在这个阶段发出。否则它将通过<code>process.nextTick()</code>发出。</p>
<h2 id="setImmediate-对比setTimeout"><a href="#setImmediate-对比setTimeout" class="headerlink" title="setImmediate()对比setTimeout()"></a><code>setImmediate()</code>对比<code>setTimeout()</code></h2><p><code>setImmediate()</code>和<code>setTimeout()</code>很类似，但何时调用行为完全不同。</p>
<ul>
<li><code>setImmediate()</code>设计为在当前<strong>轮询</strong>阶段完成后执行脚本。</li>
<li><code>setTimeout()</code>计划在毫秒的最小阈值经过后运行的脚本。</li>
</ul>
<p>执行计时器但顺序将根据调用它们的上下文而异。如果二者都从主模块内调用，则计时将首进程性能的约束（这可能会受到计算机上运行的其它应用程序的影响）。</p>
<p>例如，如果运行的是不属于I/O周期（即主模块）的以下脚本，则执行两个计时器的顺序是非确定性的，因为它受进程性能的约束：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timeout_vs_immediate.js</span></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timeout'</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">setImmediate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'immediate'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node timeout_vs_immediate.js</span></span><br><span class="line">timeout</span><br><span class="line">immediate</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> node timeout_vs_immediate.js</span></span><br><span class="line">immediate</span><br><span class="line">timeout</span><br></pre></td></tr></table></figure>
<p>但是，如果你把这两个函数放入一个I/O循环内调用，setImmediate总是被优先调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timeout_vs_immediate.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(__filename, () =&gt; &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timeout'</span>);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">  setImmediate(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'immediate'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node timeout_vs_immediate.js</span></span><br><span class="line">immediate</span><br><span class="line">timeout</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> node timeout_vs_immediate.js</span></span><br><span class="line">immediate</span><br><span class="line">timeout</span><br></pre></td></tr></table></figure>
<p>使用<code>setImmediate()</code>超过<code>setTimeout()</code>的主要优点是<code>setImmediate()</code>在任何计时器（如果在 I/O 周期内）都将始终执行，而不依赖于存在多少个计时器。</p>
<h2 id="process-nextTick"><a href="#process-nextTick" class="headerlink" title="process.nextTick()"></a><code>process.nextTick()</code></h2><h3 id="理解process-nextTick"><a href="#理解process-nextTick" class="headerlink" title="理解process.nextTick()"></a>理解<code>process.nextTick()</code></h3><p>您可能已经注意到<code>process.nextTick()</code>在关系图中没有显示，即使它是异步API的一部分。这是因为<code>process.nextTick()</code>在技术上不是事件循环的一部分。相反，无论事件循环的当前阶段如何，都将在当前操作完成后处理<code>nextTickQueue</code>。这里的一个操作被视作为一个从 C++ 底层处理开始过渡，并且处理需要执行的 JavaScript 代码。</p>
<p>回顾我们的关系图，任何时候在给定的阶段中调用<code>process.nextTick()</code>，所有传递到<code>process.nextTick()</code>的回调将在事件循环继续之前得到解决。这可能会造成一些糟糕的情况, 因为<strong>它允许您通过进行递归<code>process.nextTick()</code>来“饿死”您的I/O调用</strong>，阻止事件循环到达<strong>轮询</strong>阶段。</p>
<h3 id="为什么会允许这样？"><a href="#为什么会允许这样？" class="headerlink" title="为什么会允许这样？"></a>为什么会允许这样？</h3><p>为什么这样的事情会包含在 Node.js 中？它的一部分是一个设计理念，其中 API 应该始终是异步的，即使它不必是。以此代码段为例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">apiCall</span>(<span class="params">arg, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> arg !== <span class="string">'string'</span>)</span><br><span class="line">    <span class="keyword">return</span> process.nextTick(callback,</span><br><span class="line">                            <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'argument should be string'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码段进行参数检查。如果不正确，则会将错误传递给回调函数。最近对API进行了更新，允许将参数传递给<code>process.nextTick()</code>，允许它在回调后传递任何参数作为回调的参数传播，这样就不必嵌套函数了。</p>
<p>我们正在做的是将错误传递给用户，但仅在我们允许用户的其余代码执行之后。通过使用<code>process.nextTick()</code>，我们保证<code>apiCall()</code>始终在用户代码的其余部分之后运行其回调函数，并在允许事件循环<em>之前</em>继续进行。为了实现这一点，JS调用栈被允许展开，然后立即执行提供的回调，允许进行递归调用<code>process.nextTick()</code>，而不达到<code>RangeError: 超过 v8 的最大调用堆栈大小</code>。</p>
<p>这种哲学可能会导致一些潜在的问题。 以此代码段为例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bar;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this has an asynchronous signature, but calls callback synchronously</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">someAsyncApiCall</span>(<span class="params">callback</span>) </span>&#123; callback(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the callback is called before `someAsyncApiCall` completes.</span></span><br><span class="line">someAsyncApiCall(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// since someAsyncApiCall has completed, bar hasn't been assigned any value</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'bar'</span>, bar); <span class="comment">// undefined</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bar = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>用户将<code>someAsyncApiCall()</code>定义为具有异步签名，但实际上它是同步运行的。当调用它时，提供给<code>someAsyncApiCall()</code>的回调在同一阶段调用事件循环，因为<code>someAsyncApiCall()</code>实际上并没有异步执行任何事情。因此，回调尝试引用 bar，即使它在范围内可能还没有该变量，因为脚本无法运行到完成。</p>
<p>通过将回调置于<code>process.nextTick()</code>中，脚本仍具有运行完成的能力，允许在调用回调之前初始化所有变量、函数等。它还具有不允许事件循环继续的优点。在允许事件循环继续之前，对用户发出错误警报可能很有用。下面是使用<code>process.nextTick()</code>的上一个示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bar;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">someAsyncApiCall</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  process.nextTick(callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">someAsyncApiCall(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'bar'</span>, bar); <span class="comment">// 1</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bar = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>这又是另外一个真实的例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = net.createServer(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;).listen(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'listening'</span>, () =&gt; &#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>只有端口通过时，端口才会立即被绑定。之后可以立即调用<code>&#39;listening&#39;</code>回调。问题是<code>.on(&#39;listening&#39;)</code>回调在这个时候还没有被设置。</p>
<p>为了绕过此现象，<code>&#39;listening&#39;</code>事件在<code>nextTick()</code>中排队，以允许脚本运行到完成阶段。这允许用户设置所需的任何事件处理程序。</p>
<h3 id="process-nextTick-对比setImmediate"><a href="#process-nextTick-对比setImmediate" class="headerlink" title="process.nextTick()对比setImmediate()"></a><code>process.nextTick()</code>对比<code>setImmediate()</code></h3><p>就用户而言我们有两个类似的调用，但它们的名称令人费解。</p>
<ul>
<li><code>process.nextTick()</code>在同一个阶段立即执行。</li>
<li><code>setImmediate()</code>在以下迭代或 ‘tick’ 上触发事件循环。</li>
</ul>
<p>实质上，这两个名称应该交换，因为<code>process.nextTick()</code>比<code>setImmediate()</code>触发得更直接，但这是过去遗留问题，因此不太可能改变。如果贸然进行名称交换，将破坏 npm 上的大部分软件包。每天都有新的模块在不断增长，这意味着我们我们每等待一天，就有更多的潜在破损在发生。所以说尽管这些名称使人感到困惑，但它们的名字本身不会改变。</p>
<p><em>我们建议开发人员在所有情况下都使用<code>setImmediate()</code>，因为它更容易被推理（并且它导致代码与更广泛的环境，如浏览器 JS 所兼容。）</em></p>
<h2 id="为什么要使用-process-nextTick"><a href="#为什么要使用-process-nextTick" class="headerlink" title="为什么要使用 process.nextTick()?"></a>为什么要使用 process.nextTick()?</h2><p>主要有两个原因：</p>
<ol>
<li>允许用户处理错误，清理任何不需要的资源，或者在事件循环继续之前重试请求。</li>
<li>有时在调用堆栈已解除但在事件循环继续之前，必须允许回调运行。</li>
</ol>
<p>一个例子就是要符合用户的期望。简单示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = net.createServer();</span><br><span class="line">server.on(<span class="string">'connection'</span>, (conn) =&gt; &#123; &#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">8080</span>);</span><br><span class="line">server.on(<span class="string">'listening'</span>, () =&gt; &#123; &#125;);</span><br></pre></td></tr></table></figure>
<p>假设<code>listen()</code>在事件循环开始时运行，但侦听回调被放置在<code>setImmediate()</code>中。除非通过主机名，否则将立即绑定到端口。为使事件循环继续进行，它必须命中<strong>轮询</strong>阶段，这意味着可能会收到连接，从而允许在侦听事件之前激发连接事件。</p>
<p>另一个示例运行的函数构造函数是从<code>EventEmitter</code>继承的，它想调用构造函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyEmitter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  EventEmitter.call(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.emit(<span class="string">'event'</span>);</span><br><span class="line">&#125;</span><br><span class="line">util.inherits(MyEmitter, EventEmitter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> MyEmitter();</span><br><span class="line">myEmitter.on(<span class="string">'event'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'an event occurred!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>不能立即从构造函数中发出事件。因为脚本不会处理到用户为该事件分配回调的点。因此，在构造函数本身中可以使用<code>process.nextTick()</code>来设置回调，以便在构造函数完成后发出该事件，从而提供预期的结果：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>);</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyEmitter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  EventEmitter.call(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// use nextTick to emit the event once a handler is assigned</span></span><br><span class="line">  process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.emit(<span class="string">'event'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">util.inherits(MyEmitter, EventEmitter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> MyEmitter();</span><br><span class="line">myEmitter.on(<span class="string">'event'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'an event occurred!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/21/不会做动画的前端不是好开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/不会做动画的前端不是好开发/" itemprop="url">不会做动画的前端不是好开发(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-21T21:25:35+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://mp.weixin.qq.com/s?__biz=MjM5ODQ2MDIyMA==&amp;mid=2650713283&amp;idx=1&amp;sn=4835a1aa5a5945b88d9c527125d2c095&amp;chksm=bec0629089b7eb8625c77e51ac321cb90921c3aa239ad6b36c297c249cb13f822bbab17d547c&amp;mpshare=1&amp;scene=23&amp;srcid=0609vi7fjpG5jBy5x5ed1FNe#rd" target="_blank" rel="noopener">原文链接</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/21/一篇文章说清浏览器解析和CSS（GPU）动画优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/一篇文章说清浏览器解析和CSS（GPU）动画优化/" itemprop="url">一篇文章说清浏览器解析和CSS（GPU）动画优化(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-21T21:05:24+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://segmentfault.com/a/1190000008015671" target="_blank" rel="noopener">原文链接</a><br><a href="https://www.smashingmagazine.com/2016/12/gpu-animation-doing-it-right/" target="_blank" rel="noopener">英文原文</a><br><a href="https://csstriggers.com/" target="_blank" rel="noopener">CSS Triggers</a></p>
<h2 id="GPU是如何合成图像的"><a href="#GPU是如何合成图像的" class="headerlink" title="GPU是如何合成图像的"></a>GPU是如何合成图像的</h2><p>GPU实际上可以看作一个独立的计算机，它有自己的处理器和存储器及数据处理模型。当浏览器向GPU发送消息的时候，就像向一个外部设备发送消息。</p>
<p>你可以把浏览器向GPU发送数据的过程，与使用ajax向服务器发送消息非常类似。想一下，你用ajax向服务器发送数据，服务器是不会直接接受浏览器的存储的信息的。你需要收集页面上的数据，把它们放进一个载体里面（例如JSON），然后发送数据到远程服务器。</p>
<p>同样的，浏览器向GPU发送数据也需要先创建一个载体；只不过GPU距离CPU很近，不会像远程服务器那样可能几千里那么远。但是对于远程服务器，2秒的延迟是可以接受的；但是对于GPU，几毫秒的延迟都会造成动画的卡顿。</p>
<p>浏览器向GPU发送的数据载体是什么样？这里给出一个简单的制作载体，并把它们发送到GPU的过程。</p>
<ul>
<li>画每个复合层的图像</li>
<li>准备图层的数据</li>
<li>准备动画的着色器（如果需要）</li>
<li>向GPU发送数据</li>
</ul>
<p>所以你可以看到，每次当你添加transform:translateZ(0)或will-change：transform给一个元素，你都会做同样的工作。重绘是非常消耗性能的，在这里它尤其缓慢。在大多数情况，浏览器不能增量重绘。它不得不重绘先前被复合层覆盖的区域。</p>
<h2 id="隐式合成"><a href="#隐式合成" class="headerlink" title="隐式合成"></a>隐式合成</h2><p>一个或多个没有自己复合层的元素要出现在有复合层元素的上方，它就会拥有自己的复合层；这种情况被称为隐式合成。</p>
<p>浏览器将元素提升为一个复合层有很多种原因，下面列举了一些：</p>
<ul>
<li>3d或透视变换css属性，例如<code>translate3d</code>，<code>translateZ</code>等等（js一般通过这种方式，使元素获得复合层）</li>
<li><code>&lt;video&gt;&lt;iframe&gt;&lt;canvas&gt;&lt;webgl&gt;</code>等元素</li>
<li>混合插件（如flash）</li>
<li>元素自身的<code>opacity</code>和<code>transform</code>做 CSS 动画</li>
<li>拥有css过滤器的元素</li>
<li>使用<code>will-change</code>属性</li>
<li><code>position:fixed</code></li>
<li>元素有一个<code>z-index</code>较低且包含一个复合层的兄弟元素(换句话说就是该元素在复合层上面渲染)</li>
</ul>
<p>这看起来css动画的性能瓶颈是在重绘上，但是真实的问题是在内存上：</p>
<h2 id="内存占用"><a href="#内存占用" class="headerlink" title="内存占用"></a>内存占用</h2><p>使用GPU动画需要发送多张渲染层的图像给GPU，GPU也需要缓存它们以便于后续动画的使用。</p>
<p>一个渲染层，需要多少内存占用？为了便于理解，举一个简单的例子；一个宽、高都是<code>300px</code>的纯色图像需要多少内存？</p>
<p><code>300 * 300 * 4 = 360000</code>字节，即360kb。这里乘以4是因为，每个像素需要四个字节计算机内存来描述。</p>
<p>假设我们做一个轮播图组件，轮播图有10张图片；为了实现图片间平滑过渡的交互；为每个图像添加了<code>will-change:transform</code>。这将提升图像为复合层，它将多需要19MB的空间。<code>800 * 600 * 4 * 10 = 1920000</code>。</p>
<p>仅仅是一个轮播图组件就需要19MB的额外空间！</p>
<p>在chrome的开发者工具中打开<code>Setting</code>——&gt;<code>Experiments</code>——&gt;<code>layers</code>可以看到每个层的内存占用。</p>
<h2 id="GPU动画的优点和缺点"><a href="#GPU动画的优点和缺点" class="headerlink" title="GPU动画的优点和缺点"></a>GPU动画的优点和缺点</h2><p>现在我们可以总结一下GPU动画的优点和缺点：</p>
<ul>
<li>每秒60帧，动画平滑、流畅</li>
<li>一个合适的动画工作在一个单独的线程，它不会被大量的js计算阻塞</li>
<li>3D“变换”是便宜的</li>
</ul>
<p>缺点：</p>
<ul>
<li>提升一个元素到复合层需要额外的重绘，有时这是慢的。（即我们得到的是一个全层重绘，而不是一个增量）</li>
<li>绘图层必须传输到GPU。取决于层的数量和传输可能会非常缓慢。这可能让一个元素在中低档设备上闪烁。</li>
<li>每个复合层都需要消耗额外的内存，过多的内存可能导致浏览器的崩溃。</li>
<li>如果你不考虑隐式合成，而使用重绘；会导致额外的内存占用，并且浏览器崩溃的概率是非常高的。</li>
<li>我们会有视觉假象，例如在Safari中的文本渲染，在某些情况下页面内容将消失或变形。</li>
</ul>
<h2 id="优化技巧"><a href="#优化技巧" class="headerlink" title="优化技巧"></a>优化技巧</h2><h3 id="避免隐式合成"><a href="#避免隐式合成" class="headerlink" title="避免隐式合成"></a>避免隐式合成</h3><p>保持动画的对象的<code>z-index</code>尽可能的高。理想的，这些元素应该是body元素的直接子元素。当然，这不是总可能的。所以你可以克隆一个元素，把它放在body元素下仅仅是为了做动画。</p>
<p>将元素上设置<code>will-change</code>CSS属性，元素上有了这个属性，浏览器会提升这个元素成为一个复合层（不是总是）。这样动画就可以平滑的开始和结束。但是不要滥用这个属性，否则会大大增加内存消耗。</p>
<h3 id="动画中只使用transform和opacity"><a href="#动画中只使用transform和opacity" class="headerlink" title="动画中只使用transform和opacity"></a>动画中只使用<code>transform</code>和<code>opacity</code></h3><h3 id="减小复合层的尺寸"><a href="#减小复合层的尺寸" class="headerlink" title="减小复合层的尺寸"></a>减小复合层的尺寸</h3><p>对于图片，你要怎么做呢？你可以将图片的尺寸减少5%—10%，然后使用<code>scale</code>将它们放大；用户不会看到什么区别，但是你可以减少大量的存储空间。</p>
<h3 id="用css动画而不是js动画"><a href="#用css动画而不是js动画" class="headerlink" title="用css动画而不是js动画"></a>用css动画而不是js动画</h3><p>css动画有一个重要的特性，它是完全工作在GPU上。因为你声明了一个动画如何开始和如何结束，浏览器会在动画开始前准备好所有需要的指令；并把它们发送给GPU。而如果使用js动画，浏览器必须计算每一帧的状态；为了保证平滑的动画，我们必须在浏览器主线程计算新状态；把它们发送给GPU至少60次每秒。除了计算和发送数据比css动画要慢，主线程的负载也会影响动画； 当主线程的计算任务过多时，会造成动画的延迟、卡顿。</p>
<p>所以尽可能地使用基于css的动画，不仅仅更快；也不会被大量的js计算所阻塞。</p>
<h2 id="优化技巧总结"><a href="#优化技巧总结" class="headerlink" title="优化技巧总结"></a>优化技巧总结</h2><ul>
<li>减少浏览器的重排和重绘的发生</li>
<li>不要使用table布局</li>
<li>css动画中尽量只使用transform和opacity，这不会发生重排和重绘</li>
<li>尽可能地只使用css做动画</li>
<li>避免浏览器的隐式合成</li>
<li>改变复合层的尺寸</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/21/深入浏览器理解CSS-animations-和-transitions的性能问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/深入浏览器理解CSS-animations-和-transitions的性能问题/" itemprop="url">深入浏览器理解CSS animations 和 transitions的性能问题(转)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-21T20:47:51+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://blog.csdn.net/leer168/article/details/25917093" target="_blank" rel="noopener">原文链接</a></p>
<h2 id="浏览器内部两个重要的线程"><a href="#浏览器内部两个重要的线程" class="headerlink" title="浏览器内部两个重要的线程"></a>浏览器内部两个重要的线程</h2><ul>
<li>主线程</li>
<li>合成线程</li>
</ul>
<p>一般情况下，主线程负责：</p>
<ul>
<li>Javascript</li>
<li>计算DOM &amp;&amp; CSSOM</li>
<li>计算Layout</li>
<li>将元素绘制到一个或多个位图中</li>
<li>将这些位图交给合成线程</li>
</ul>
<p>相应地，合成线程负责：</p>
<ul>
<li>通过GPU将位图绘制到屏幕上</li>
<li>同志主线程更新页面中可见或即将变成可见到部分到位图</li>
<li>计算出页面中哪部分是可见到</li>
<li>计算出当你在滚动页面时哪部分是即将变成可见到</li>
<li>当你在滚动页面时将相应位置到元素移动到可视区域</li>
</ul>
<p>当用户滚动页面时，合成线程会通知主线程更新页面中最新可见部分到位图。但是，如果主线程响应慢，合成线程不会等待，而是马上绘制已经生成到位图，还没准备好的部分用白色进行填充。</p>
<h2 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h2><p>快在于：</p>
<ol>
<li>绘制位图到屏幕上</li>
<li>一遍又一遍绘制相同到位图</li>
<li>将同一位图绘制到不同位置，执行旋转以及缩放处理</li>
</ol>
<p>慢在于：</p>
<ol>
<li>将位图加载到它的内存中</li>
</ol>
<p>因此，修改元素的height要比修改transform属性性能消耗大。这是因为对height的修改需要不断的relayout、repaint，这两个步骤的计算量可能是巨大的。而transform属性不会更改元素或它周围的元素的布局。transform属性会对元素的整体产生影响，它会对整个元素进行缩放、旋转、移动处理。</p>
<p>以下CSS属性在动画处理方面是比较快的：</p>
<ul>
<li>CSS transform</li>
<li>CSS opacity</li>
<li>CSS filter</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/21/深入理解ES6-迭代器和生成器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/深入理解ES6-迭代器和生成器/" itemprop="url">深入理解ES6-迭代器(Iterator)和生成器(generator)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-21T09:47:33+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用循环语句迭代数据时，必须要初始化一个变量来记录每一次迭代在数据集合中的位置，迭代器的使用可以极大的简化数据操作。</p>
<h2 id="什么是迭代器Iterator"><a href="#什么是迭代器Iterator" class="headerlink" title="什么是迭代器Iterator"></a>什么是迭代器Iterator</h2><p>迭代器是一种特殊的对象，具有专门的接口，所有迭代器对象都有一个next方法，每次调用都返回一个结果对象。</p>
<p>结果对象有两个属性：一个是<code>value</code>，表示下一个将要返回的值；另一个是<code>done</code>，是一个布尔值，当没有更多可返回数据时返回true。</p>
<p>迭代器还会保存一个内部指针，用来指向当前集合中值的位置，没调用一次<code>next()</code>方法，都会返回下一个可用的值。</p>
<p>如果最后一个值返回后再调用<code>next()</code>方法，返回的对象中属性<code>done</code>为true，<code>value</code>则包含迭代器最终返回的值，这个返回值不是数据集的一部分，与函数的返回值类似，是函数调用过程中最后一次给调用者传递信息的方法，如果没有相关数据则返回<code>undefined</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES5 语法创建一个迭代器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createIterator</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    next: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> done = (i &gt;= items.length);</span><br><span class="line">      <span class="keyword">var</span> value = !done ? items[i++] : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        done: done,</span><br><span class="line">        value: value</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> iterator = createIterator([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: 1, done: false &#125;"</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: 2, done: false &#125;"</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: 3, done: false &#125;"</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: undefined, done: true &#125;"</span></span><br></pre></td></tr></table></figure>
<h2 id="什么是生成器Generator"><a href="#什么是生成器Generator" class="headerlink" title="什么是生成器Generator"></a>什么是生成器Generator</h2><p>生成器是一种返回迭代器的函数，通过<code>function</code>关键字后的星号(<code>*</code>)来表示，函数中会用到新的关键字<code>yield</code>。星号可以紧挨着<code>function</code>关键字，也可以在中间添加一个空格：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">createIterator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>yield</code>关键字也是ES6的新特性，可以通过它来指定调用迭代器的<code>next()</code>方法时的返回值及返回顺序。</p>
<p>生成器函数最有序的部分大概是：每当执行完一条<code>yield</code>语句后函数就会自动停止执行，直到再次调用迭代器的<code>next()</code>方法才会继续执行下一个<code>yield</code>语句。</p>
<p>使用<code>yield</code>关键字可以返回任何值或表达式，因此可以通过生成器函数批量的给迭代器添加元素。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">createIterator</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>, len = items.length; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">yield</span> items[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> iterator = createIterator([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: 1, done: false &#125;"</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: 2, done: false &#125;"</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: 3, done: false &#125;"</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// "&#123; value: undefined, done: true &#125;"</span></span><br></pre></td></tr></table></figure>
<h3 id="yield的使用限制"><a href="#yield的使用限制" class="headerlink" title="yield的使用限制"></a>yield的使用限制</h3><p>yield关键字只可在生成器内部使用，在其它地方使用会导致程序抛出语法错误，即便在生成器内部的函数里使用也是如此。常见案例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">createIterator</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">  items.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123; </span><br><span class="line">    <span class="comment">// 语法错误</span></span><br><span class="line">    <span class="keyword">yield</span> item + <span class="number">1</span>; </span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="可迭代对象和for-of循环"><a href="#可迭代对象和for-of循环" class="headerlink" title="可迭代对象和for-of循环"></a>可迭代对象和<code>for-of</code>循环</h2><p>可迭代对象具有<code>Symbol.iterator</code>属性，是一种与迭代器密切相关的对象。<code>Symbol.iterator</code>通过指定的函数可以返回一个作用于附属对象的迭代器。在ES6中，所有的集合对象（数组、<code>Set</code>集合及<code>Map</code>集合）和字符串都是可迭代对象，这些对象中都有默认的迭代器。</p>
<p><code>for-of</code>循环每执行一次都会调用可迭代对象的<code>next()</code>方法，并将迭代器返回的结果对象的<code>value</code>属性存储在一个变量中，循环将持续执行这一过程直到返回对象的<code>done</code>属性的值为true。</p>
<h2 id="访问默认迭代器"><a href="#访问默认迭代器" class="headerlink" title="访问默认迭代器"></a>访问默认迭代器</h2><p>可以通过<code>Symbol.iterator</code>来访问对象默认的迭代器。</p>
<p>由于具有<code>Symbol.iterator</code>属性的对象都有默认的迭代器，因此可以用它来检测对象是否为可迭代对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isIterable</span>(<span class="params">object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> object[<span class="built_in">Symbol</span>.iterator] === <span class="string">'function'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建可迭代对象"><a href="#创建可迭代对象" class="headerlink" title="创建可迭代对象"></a>创建可迭代对象</h2><p>默认情况下，开发者定义的对象都是不可迭代对象，但如果给<code>Symbol.iterator</code>属性添加一个生成器，则可以将其变为可迭代对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> collection = &#123;</span><br><span class="line">  items: [],</span><br><span class="line">  *[<span class="built_in">Symbol</span>.iterator]() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> <span class="keyword">this</span>.items) &#123;</span><br><span class="line">      <span class="keyword">yield</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">collection.items.push(<span class="number">1</span>);</span><br><span class="line">collection.items.push(<span class="number">2</span>);</span><br><span class="line">collection.items.push(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> x <span class="keyword">of</span> collection) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出结果</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<h2 id="内建迭代器"><a href="#内建迭代器" class="headerlink" title="内建迭代器"></a>内建迭代器</h2><p>在ES6中有3中类型但集合对象：数组、<code>Map</code>集合与<code>Set</code>集合。为了更好的访问对象中的内容，这3种对象都内建来三种迭代器：</p>
<ul>
<li>entries()</li>
<li>values()</li>
<li>keys()</li>
</ul>
<h3 id="entries-迭代器-TODO"><a href="#entries-迭代器-TODO" class="headerlink" title="entries()迭代器(TODO)"></a>entries()迭代器(TODO)</h3><h3 id="values-迭代器-TODO"><a href="#values-迭代器-TODO" class="headerlink" title="values()迭代器(TODO)"></a>values()迭代器(TODO)</h3><h3 id="keys-迭代器-TODO"><a href="#keys-迭代器-TODO" class="headerlink" title="keys()迭代器(TODO)"></a>keys()迭代器(TODO)</h3><h2 id="字符串迭代器"><a href="#字符串迭代器" class="headerlink" title="字符串迭代器"></a>字符串迭代器</h2><p>由于方括号操作的是编码单元而非字符，因此无法正确访问双字节字符。由于双字节字符被视作两个独立的编码单元，在使用方括号获取双字节字符时得到的是两个空。</p>
<p>所幸，ES6的目标是全面支持Unicode，并且我们可以通过改变字符串的默认迭代器来解决这个问题，使其操作字符而不是编码单元。</p>
<h2 id="NodeList迭代器"><a href="#NodeList迭代器" class="headerlink" title="NodeList迭代器"></a><code>NodeList</code>迭代器</h2><p>自从ES6添加了默认迭代器后，DOM定义中的<code>NodeList</code>类型（定义在HTML标准而不是ES6标准中）也拥有了默认迭代器，其行为与数组的默认迭代器完全一致。所以可以将<code>NodeList</code>应用于<code>for-of</code>循环及其他支持对象默认迭代器的地方。</p>
<h2 id="展开运算符与非数组可迭代对象"><a href="#展开运算符与非数组可迭代对象" class="headerlink" title="展开运算符与非数组可迭代对象"></a>展开运算符与非数组可迭代对象</h2><p>由于展开运算符可以作用于任意可迭代对象，因此如果想将可迭代对象转换为数组，这是最简单的方法。你既可以将字符串中的每一个字符（不是编码单元）存入新数组中，也可以将浏览器中的<code>NodeList</code>对象中的每一个节点存入新数组中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">set</span> = new Set([1, 2, 3]),</span><br><span class="line">  map = new Map(['name', 'Nicholas'], ['age', 25]),</span><br><span class="line">  arrSet = [...<span class="keyword">set</span>],</span><br><span class="line">  arrMap = [...map];</span><br><span class="line"></span><br><span class="line">console.log(arrSet); // [1, 2, 3]</span><br><span class="line">console.log(arrMap); // ['name', 'Nicholas'], ['age', 25]</span><br></pre></td></tr></table></figure>
<h2 id="高级迭代器功能"><a href="#高级迭代器功能" class="headerlink" title="高级迭代器功能"></a>高级迭代器功能</h2><h3 id="给迭代器传递参数-TODO"><a href="#给迭代器传递参数-TODO" class="headerlink" title="给迭代器传递参数(TODO)"></a>给迭代器传递参数(TODO)</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/20/使用React-Virtualized渲染列表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/使用React-Virtualized渲染列表/" itemprop="url">使用React Virtualized渲染列表(译)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-20T22:05:57+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://css-tricks.com/rendering-lists-using-react-virtualized/" target="_blank" rel="noopener">原文链接</a></p>
<p>使用React处理数据相对来说比较容易，因为React的设计就是把数据当作状态。但是当你需要处理的数据量很大的时候，麻烦就来了。比如你要处理一个包含500-1000条记录的数据集，这会产生巨大的计算量并导致性能问题。下面我们将学习如何使用虚拟列表来“看起来”渲染了一个长列表。</p>
<p>我们将使用<a href="https://github.com/bvaughn/react-virtualized" target="_blank" rel="noopener">React Virtualized</a>组件来实现我们的需求。它让我们可以以很小的代价渲染大集合数据。</p>
<h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><p>React Virtualized官方已经有很详细的介绍了，可以去它们的<a href="https://github.com/bvaughn/react-virtualized" target="_blank" rel="noopener">github</a>去看看。</p>
<p>我们需要大量的数据，下面我们就来造一些。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRecord</span>(<span class="params">count</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> records = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    records.push(&#123;</span><br><span class="line">      username: faker.internet.userName(),</span><br><span class="line">      email: faker.internet.email()</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> records;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面，我们设置一个数字来创造我们需要的数据：</p>
<pre><code>const records = createRecord(1000);
</code></pre><p>好了，现在我们有需要渲染的数据了。</p>
<h2 id="创建一个虚拟列表"><a href="#创建一个虚拟列表" class="headerlink" title="创建一个虚拟列表"></a>创建一个虚拟列表</h2><p><a href="https://codepen.io/kinsomicrote/pen/NOQXeK" target="_blank" rel="noopener">这里</a>是我们创建的一个列表，我们引入使用了库提供的一些展示样式，本篇post不讨论这个。<br>现在开始感受一下这个<a href="https://codepen.io/kinsomicrote/pen/NOQXeK" target="_blank" rel="noopener">demo</a>，速度超级快，是不是？</p>
<p>你可能想知道这背后到底发生了什么，结果发现是一系列很疯狂和酷的sizing、positioning、transform和transitions，是这些技术让一条条记录进入/离开可视区。数据都在那里并渲染了，React Virtualized创建了一个window，当用户scroll的时候，一条条记录将滑入/出我们的视野。</p>
<p>为了渲染虚拟列表，我们需要<code>List</code>组件，它内部渲染了一个<code>Grid</code>组件。</p>
<p>首先，我们从设置<code>rowRenderer</code>，开始，它是负责渲染单挑数据的组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rowRenderer = <span class="function">(<span class="params">&#123; index, isScrolling, key, style &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div key=&#123;key&#125; style=&#123;style&#125;&gt;</span><br><span class="line">        &lt;div&gt;&#123;<span class="keyword">this</span>.props.data[index].username&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;&#123;this.props.data[index].email&#125;&lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br></pre></td></tr></table></figure>
<p>它返回一个包含两个<code>div</code>的div<code>，里面的两个</code>div<code>分别是</code>username<code>和</code>email`。可以看出，这是一个简单的展示用户信息的列表。</p>
<p><code>rowRenderer</code>接受几个参数，下面是这些参数的细节：</p>
<ul>
<li><code>index</code>: 记录的数值ID</li>
<li><code>isScrolling</code>: 代表<code>List</code>组件是否发生scrolling</li>
<li><code>isVisible</code>: 代表这条数据是否在可视区内</li>
<li><code>key</code>: 这条记录在数组中的位置</li>
<li><code>parent</code>: 定义这个列表是否是另一个列表的parent/child</li>
<li><code>style</code>: 定位这条数据的style对象</li>
</ul>
<p>下面我们再深入了解一些<code>rowRenderer</code>函数，我们把它放到<code>List</code>组件中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;List</span><br><span class="line">  rowCount=&#123;<span class="keyword">this</span>.props.data.length&#125;</span><br><span class="line">  width=&#123;width&#125;</span><br><span class="line">  height=&#123;height&#125;</span><br><span class="line">  rowHeight=&#123;rowHeight&#125;</span><br><span class="line">  rowRenderer=&#123;<span class="keyword">this</span>.rowRenderer&#125;</span><br><span class="line">  overscanRowCount=&#123;<span class="number">3</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>你可能注意到这里的几个参数：</p>
<ul>
<li><code>rowCount</code>: 接收代表列表长度的数字</li>
<li><code>width</code>: 列表的宽度</li>
<li><code>height</code>: 列表的高度</li>
<li><code>rowHeight</code>: 每条数据的高度</li>
<li><code>rowRenderer</code>: 用来渲染每条数据的模板，我们将传入之前定义的<code>rowRenderer</code>函数</li>
<li><code>overscanRowCount</code>:<br>用来渲染用户scroll方向额外的数据，防止用户滑动太快，虚拟内容来不及渲染。</li>
</ul>
<p>最后，代码应该是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; List &#125; = ReactVirtualized</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> height = <span class="number">700</span>;</span><br><span class="line"><span class="keyword">const</span> rowHeight = <span class="number">40</span>;</span><br><span class="line"><span class="keyword">const</span> width = <span class="number">800</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  rowRenderer = <span class="function">(<span class="params">&#123; index, isScrolling, key, style &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div key=&#123;key&#125; style=&#123;style&#125;&gt;</span><br><span class="line">        &lt;div&gt;&#123;<span class="keyword">this</span>.props.data[index].username&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;&#123;this.props.data[index].email&#125;&lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;h2&gt;Details&lt;/</span>h2&gt;</span><br><span class="line">        &lt;List</span><br><span class="line">          rowCount=&#123;<span class="keyword">this</span>.props.data.length&#125;</span><br><span class="line">          width=&#123;width&#125;</span><br><span class="line">          height=&#123;height&#125;</span><br><span class="line">          rowHeight=&#123;rowHeight&#125;</span><br><span class="line">          rowRenderer=&#123;<span class="keyword">this</span>.rowRenderer&#125;</span><br><span class="line">          overscanRowCount=&#123;<span class="number">3</span>&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="Cell-measure"><a href="#Cell-measure" class="headerlink" title="Cell measure"></a>Cell measure</h2><p>文档里介绍，cell<br>measure是一个高阶组件，用来暂时渲染列表。现在我们还看不到它，但数据已经在里面被处理并准备好展示了。</p>
<p>什么时候我们需要关心cell measure？最常见的use<br>case是当我们需要动态计算<code>rowHeight</code>的时候。React<br>Virtualized在渲染每一行的时候，会缓存它们的高度值，这样当数据滑出可视区的时候我们也不用再计算它的高度——不管里面的内容是什么，高度都是对的。</p>
<p>首先，我们创建自己的缓存<code>cache</code>，在我们组件的<code>constructor</code>里用<code>CellMeasureCache</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>() &#123;</span><br><span class="line">  <span class="keyword">super</span>()</span><br><span class="line">  <span class="keyword">this</span>.cache = <span class="keyword">new</span> CellMeasurerCache(&#123;</span><br><span class="line">    fixedWidth: <span class="literal">true</span>,</span><br><span class="line">    defaultHeight: <span class="number">100</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们设置<code>List</code>组件的时候，把<code>cache</code>带上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;List</span><br><span class="line">  rowCount=&#123;<span class="keyword">this</span>.props.data.length&#125;</span><br><span class="line">  width=&#123;rowWidth&#125;</span><br><span class="line">  height=&#123;listHeight&#125;</span><br><span class="line">  deferredMeasurementCache=&#123;<span class="keyword">this</span>.cache&#125;</span><br><span class="line">  rowHeight=&#123;<span class="keyword">this</span>.cache.rowHeight&#125;</span><br><span class="line">  rowRenderer=&#123;<span class="keyword">this</span>.renderRow&#125;</span><br><span class="line">  overscanRowCount=&#123;<span class="number">3</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>传给<code>deferredMeasurementCache</code>的值会被用来暂时渲染数据，接着——当<code>rowHeight</code>的计算结果出来的时候——额外的行会流入，就像它们一直在那里。</p>
<p>接着我们将在<code>rowRenderer</code>函数里使用<code>CellMeasure</code>替换我们之前的<code>div</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rowRenderer = <span class="function">(<span class="params">&#123; index, parent, key, style &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;CellMeasurer</span><br><span class="line">      key=&#123;key&#125;</span><br><span class="line">      cache=&#123;<span class="keyword">this</span>.cache&#125;</span><br><span class="line">      parent=&#123;parent&#125;</span><br><span class="line">      columnIndex=&#123;<span class="number">0</span>&#125;</span><br><span class="line">      rowIndex=&#123;index&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;div style=&#123;style&#125;&gt;</span><br><span class="line">        &lt;div&gt;&#123;<span class="keyword">this</span>.props.data[index].username&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;&#123;this.props.data[index].email&#125;&lt;/</span>div&gt;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>CellMeasurer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>现在数据已经被获取、缓存并准备好展示在虚拟window里了！</p>
<h2 id="虚拟table"><a href="#虚拟table" class="headerlink" title="虚拟table"></a>虚拟table</h2><p>虽然本片post主要说列表，但万一当我们需要渲染table怎么办？React<br>Virtualized也帮我们做了这件事情。这时我们需要使用<code>Table</code>和<code>Column</code>组件。</p>
<p>下面是代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;Details&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">        &lt;Table</span></span><br><span class="line"><span class="regexp">          width=&#123;500&#125;</span></span><br><span class="line"><span class="regexp">          height=&#123;300&#125;</span></span><br><span class="line"><span class="regexp">          headerHeight=&#123;20&#125;</span></span><br><span class="line"><span class="regexp">          rowHeight=&#123;40&#125;</span></span><br><span class="line"><span class="regexp">          rowCount=&#123;this.props.data.length&#125;</span></span><br><span class="line"><span class="regexp">          rowGetter=&#123;(&#123; index &#125;) =&gt; this.props.data[index]&#125;</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">          &lt;Column</span></span><br><span class="line"><span class="regexp">            label='Username'</span></span><br><span class="line"><span class="regexp">            dataKey='username'</span></span><br><span class="line"><span class="regexp">            width=&#123;100&#125;</span></span><br><span class="line"><span class="regexp">          /</span>&gt;</span><br><span class="line"></span><br><span class="line">          &lt;Column</span><br><span class="line">            width=&#123;<span class="number">200</span>&#125;</span><br><span class="line">            label=<span class="string">'Email'</span></span><br><span class="line">            dataKey=<span class="string">'email'</span></span><br><span class="line">          /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Table&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<code>Table</code>组件包括下面的参数：</p>
<ul>
<li><code>width</code></li>
<li><code>height</code></li>
<li><code>headerHeight</code></li>
<li><code>rowHeight</code></li>
<li><code>rowCount</code></li>
<li><code>rowGetter</code>: 返回这行的数据</li>
</ul>
<p>如果看一下<code>Column</code>组件，你会发现我们设置了一个<code>dataKey</code>参数。它是每条数据拥有的独一无二的id。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>希望这篇post可以帮你了解React<br>Virtualized可以做哪些事情，它如何让列表渲染变得很快，并如何在项目中使用它。</p>
<p>我们只讨论了皮毛，这个库覆盖了更多的use case，如在scroll的时候为记录generate<br>placeholders、实时获取/缓存数据的无限加载组件等等。</p>
<p>它将给你很多可以play with的东西！</p>
<p>此外，这个包维护的很好，实际上你可以加入<a href="https://react-virtualized.now.sh/" target="_blank" rel="noopener">Slack group</a>来跟踪这个项目，贡献它，和其他folks取得联系。</p>
<p>还有一条值得注意的是，React Virtualized在<a href="https://stackoverflow.com/questions/tagged/react-virtualized" target="_blank" rel="noopener">StackOverflow上有它自己的标签</a>，这是一个寻找问题的答案的地方，也可以po出你的问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://buptlyz.github.io/2019/04/20/周震南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="沙雕爹爹">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="沙雕爹爹">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/20/周震南/" itemprop="url">周震南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-20T21:49:58+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>周震南，2000年的小弟弟，今年6月才19岁，但真的很酷，我完全被圈粉了。</p>
<h2 id="第一次的表演是小星星"><a href="#第一次的表演是小星星" class="headerlink" title="第一次的表演是小星星"></a>第一次的表演是小星星</h2><p>在创造营2019的第二期，和一个老前辈battle，唱的小星星，那段rap真的太酷了。</p>
<h2 id="vlog"><a href="#vlog" class="headerlink" title="vlog"></a>vlog</h2><p>创造营vlog-周震南，就是酷酷的，到了切苹果的时候，才暴露出18岁小孩子的一面，无厘头和幼稚。但还是透着酷。</p>
<h2 id="公演"><a href="#公演" class="headerlink" title="公演"></a>公演</h2><p>作为队长，对队员的表现不满意，连续两天练习到凌晨五、六点。有队员对这样的练习计划表示质疑，太累了，效率很低，不如早点休息，然后第二天早点开始。周震南回应很简单：“谁都不想练到五六点，为什么练到五六点，不是因为还没练好吗？练完了大家都可以回去睡觉。”这里表达的是唯结果论，几点睡有什么关系，达不到目标就不要休息。</p>
<h2 id="公演结束，胜利的眼泪"><a href="#公演结束，胜利的眼泪" class="headerlink" title="公演结束，胜利的眼泪"></a>公演结束，胜利的眼泪</h2><p>第一次公演结束，投票结果周震南队赢了，接着就是周震南啜泣的声音。为什么哭了？不知道，只有自己知道。我觉得他应该是压力太大了。自己对自己要求很高，同时其他人对他要求也很高，公演练习的过程很辛苦，最终的结果是好的，让他觉得付出有了收获。</p>
<h2 id="00后"><a href="#00后" class="headerlink" title="00后"></a>00后</h2><p>00后都已经这么努力了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">沙雕爹爹</p>
              <p class="site-description motion-element" itemprop="description">Personal tech blog.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">沙雕爹爹</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
